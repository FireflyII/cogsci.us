<?php
session_start();
?>
<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>Problem Experiment Pilot</title>
	<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
</head>

<body>
    <?php
    	//session_start();
		function getRealIpAddr(){
	    	if (!empty($_SERVER['HTTP_CLIENT_IP']))   //check ip from share internet
	    	{
	      		$ip=$_SERVER['HTTP_CLIENT_IP'];
	    	}
	    	elseif (!empty($_SERVER['HTTP_X_FORWARDED_FOR']))   //to check ip is pass from proxy
	    	{
	      		$ip=$_SERVER['HTTP_X_FORWARDED_FOR'];
	    	}
	    	else
	    	{
	      		$ip=$_SERVER['REMOTE_ADDR'];
	    	}
	    	return $ip;
		}
		$ip = getRealIpAddr();
		$uid = `python pilot.py 8`;
		$nameErr = "";

		if ($_SERVER["REQUEST_METHOD"] == "POST"){
			//test_input($_POST["name"]);
			$uid = $_POST["name"];
			$check = `python csvcheck.py {$uid} {$ip}`;
			if ($check == 1){
				$nameErr = "That name is in use. Please try another.";
			} else {
				//echo "That'll work. <br>";
				$codes = `python csvadd.py {$uid} {$ip}`;
				$codes2 = str_getcsv($codes);
				$_SESSION["cond"]=$codes2[0];
				$_SESSION["completion"]=$codes2[1];
				$_SESSION["ip"]=$ip;
				$_SESSION["worker"]=$uid;
				echo "<script type=\"text/javascript\"> window.location = \"consent.html\" </script>";

			}
			//echo "<br>" . $check; 
		}
		?>

		<h1>Pilot Data</h1>
		<h2>A random user name has been generated for you in case you would prefer to remain anonymous. If so, please click the "Next" button. Otherwise, you may enter your name before proceeding. Thank you in advance! </h2><br>
	<form method="post" action="<?php echo htmlspecialchars($_SERVER["PHP_SELF"]);?>">
		User: <input type="text" name="name" value=<?php echo $uid ?>>
		<span class="error"> <?php echo $nameErr;?></span><br><br>
		<input type="submit" name="submit" value="Next">
	</form>

</body>
</html>